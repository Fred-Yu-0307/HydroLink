<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - HydroLink</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <!-- Font Awesome for scan icon -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/settings.css">
    <style>
        /* Custom styles for settings page */
        body {
            background: linear-gradient(135deg, #dbeafe 0%, #f8fafc 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .settings-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .settings-nav {
            flex: 0 0 250px; /* Fixed width for navigation */
        }

        .settings-content {
            flex-grow: 1;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: none;
        }

        .card-header {
            background-color: #2563eb;
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 1rem 1.5rem;
            font-weight: bold;
        }

        .list-group-item-action {
            padding: 1rem 1.5rem;
            font-weight: 500;
            color: #4a5568;
        }

        .list-group-item-action:hover {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .list-group-item-action.active {
            background-color: #2563eb !important;
            color: white !important;
            border-color: #2563eb !important;
        }

        .form-floating > .form-control,
        .form-floating > .form-select,
        .form-floating > .form-control:focus,
        .form-floating > .form-select:focus {
            border-radius: 10px;
            height: calc(3.5rem + 2px);
            padding: 1rem 0.75rem;
        }

        .form-floating > label {
            padding: 1rem 0.75rem;
        }

        .save-btn {
            background-color: #2563eb;
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease;
        }

        .save-btn:hover {
            background-color: #1e40af;
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: #2563eb;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid white;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e7ff;
            padding-bottom: 0.5rem;
        }

        .password-strength {
            margin-top: 10px;
        }

        .password-strength .progress-bar {
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .notification-group-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 1rem;
        }

        .notification-option {
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .notification-option:last-child {
            border-bottom: none;
        }

        .device-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-icon {
            width: 40px;
            height: 40px;
            background-color: #e0f2fe;
            color: #2563eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            animation: fadeIn 0.5s, fadeOut 0.5s 3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Styles for the modal's scan section, adapted from setup.html */
        .scan-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px dashed var(--accent-teal);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .scan-section.scanning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: var(--warning-orange);
            animation: pulse 2s infinite;
        }

        .scan-section.completed {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: var(--accent-green);
        }

        .water-level-display {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .water-tank-visual {
            width: 100px;
            height: 200px;
            border: 3px solid #2563eb; /* Using primary blue */
            border-radius: 10px;
            position: relative;
            margin: 0 auto 1rem;
            overflow: hidden;
            background: #f8fafc;
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #0891b2 0%, #2563eb 100%); /* Using accent-teal and primary-blue */
            transition: height 1s ease;
            border-radius: 0 0 7px 7px;
        }

        .icon-large {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .hidden {
            display: none !important;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-droplet-fill me-2"></i>HydroLink
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html">History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="setup.html">Setup Device</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="auth.html">
                            <i class="bi bi-person-circle"></i> Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#notifications">
                            <i class="bi bi-bell-fill"></i>
                            <span class="badge bg-danger notification-badge">3</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold">Account Settings</h1>
                <p class="lead">Manage your profile, preferences, and account information</p>
            </div>
            <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
                <div class="user-avatar">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=JD&background=linear-gradient(45deg,4a9ff5,9c27b0)&color=fff&rounded=true&size=200" alt="User Avatar">
                    <div class="avatar-edit">
                        <i class="bi bi-pencil-fill"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="settings-container">
            <!-- Settings Navigation -->
            <div class="settings-nav">
                <div class="card shadow-sm">
                    <div class="list-group list-group-flush">
                        <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                            <i class="bi bi-person-fill me-3"></i>Profile
                        </a>
                        <a href="#address" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="bi bi-geo-alt-fill me-3"></i>Address
                        </a>
                        <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="bi bi-bell-fill me-3"></i>Notifications
                        </a>
                        <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="bi bi-shield-lock-fill me-3"></i>Security
                        </a>
                        <a href="#devices" class="list-group-item list-group-item-action" data-bs-toggle="list">
                            <i class="bi bi-hdd-fill me-3"></i>Devices
                        </a>
                    </div>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="settings-content">
                <div class="tab-content">
                    <!-- Profile Tab -->
                    <div class="tab-pane fade show active" id="profile">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Personal Information</h5>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="row mb-4">
                                        <div class="col-md-4 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="firstName" placeholder="First Name" value="">
                                                <label for="firstName"><i class="bi bi-person me-2"></i>First Name</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="middleName" placeholder="Middle Name" value="">
                                                <label for="middleName"><i class="bi bi-person me-2"></i>Middle Name</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="lastName" placeholder="Last Name" value="">
                                                <label for="lastName"><i class="bi bi-person me-2"></i>Last Name</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <input type="email" class="form-control" id="email" placeholder="Email" value="" readonly>
                                                <label for="email"><i class="bi bi-envelope me-2"></i>Email</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="tel" class="form-control" id="phone" placeholder="Phone Number" value="">
                                                <label for="phone"><i class="bi bi-telephone me-2"></i>Phone Number</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <select class="form-select" id="gender">
                                                    <option value="male">Male</option>
                                                    <option value="female">Female</option>
                                                    <option value="other">Other</option>
                                                    <option value="prefer-not">Prefer not to say</option>
                                                </select>
                                                <label for="gender"><i class="bi bi-gender-ambiguous me-2"></i>Gender</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="date" class="form-control" id="birthdate" value="">
                                                <label for="birthdate"><i class="bi bi-calendar-event me-2"></i>Date of Birth</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-floating mb-4">
                                        <textarea class="form-control" id="bio" style="height: 100px"></textarea>
                                        <label for="bio"><i class="bi bi-file-text me-2"></i>Bio</label>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-light me-2">Cancel</button>
                                        <button type="submit" class="btn btn-primary save-btn" id="saveProfileBtn">
                                            <span class="btn-text">Save Changes</span>
                                            <span class="btn-icon"><i class="bi bi-check-circle"></i></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Address Tab -->
                    <div class="tab-pane fade" id="address">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Address Information</h5>
                            </div>
                            <div class="card-body">
                                <form id="addressForm">
                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <select class="form-select" id="region">
                                                    <option value="" selected disabled>Select Region</option>
                                                    <option value="ncr">National Capital Region</option>
                                                    <option value="car">Cordillera Administrative Region</option>
                                                    <option value="region1">Region I - Ilocos Region</option>
                                                    <option value="region2">Region II - Cagayan Valley</option>
                                                    <option value="region3">Region III - Central Luzon</option>
                                                    <option value="region4a">Region IV-A - CALABARZON</option>
                                                    <option value="region4b">Region IV-B - MIMAROPA</option>
                                                    <option value="region5">Region V - Bicol Region</option>
                                                    <option value="region6">Region VI - Western Visayas</option>
                                                    <option value="region7">Region VII - Central Visayas</option>
                                                    <option value="region8">Region VIII - Eastern Visayas</option>
                                                    <option value="region9">Region IX - Zamboanga Peninsula</option>
                                                    <option value="region10">Region X - Northern Mindanao</option>
                                                    <option value="region11">Region XI - Davao Region</option>
                                                    <option value="region12">Region XII - SOCCSKSARGEN</option>
                                                    <option value="region13">Region XIII - Caraga</option>
                                                    <option value="barmm">Bangsamoro Autonomous Region in Muslim Mindanao</option>
                                                </select>
                                                <label for="region"><i class="bi bi-map me-2"></i>Region</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <select class="form-select" id="province" disabled>
                                                    <option value="" selected disabled>Select Province</option>
                                                </select>
                                                <label for="province"><i class="bi bi-geo me-2"></i>Province</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <select class="form-select" id="city" disabled>
                                                    <option value="" selected disabled>Select City/Municipality</option>
                                                </select>
                                                <label for="city"><i class="bi bi-building me-2"></i>City/Municipality</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <select class="form-select" id="barangay" disabled>
                                                    <option value="" selected disabled>Select Barangay</option>
                                                </select>
                                                <label for="barangay"><i class="bi bi-house me-2"></i>Barangay</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="streetName" placeholder="Street Name">
                                                <label for="streetName"><i class="bi bi-signpost me-2"></i>Street Name</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <select class="form-select" id="zipcode" disabled>
                                                    <option value="" selected disabled>Select Zipcode</option>
                                                </select>
                                                <label for="zipcode"><i class="bi bi-mailbox me-2"></i>Zipcode</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-floating mb-4">
                                        <textarea class="form-control" id="addressNotes" style="height: 100px" placeholder="Additional Address Notes"></textarea>
                                        <label for="addressNotes"><i class="bi bi-pencil me-2"></i>Additional Address Notes</label>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-light me-2">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <span class="btn-text">Save Address</span>
                                            <span class="btn-icon"><i class="bi bi-check-circle"></i></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Tab -->
                    <div class="tab-pane fade" id="notifications">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Notification Preferences</h5>
                            </div>
                            <div class="card-body">
                                <form id="notificationsForm">
                                    <div class="notification-group mb-4">
                                        <h6 class="notification-group-title">System Notifications</h6>
                                        <div class="notification-option">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">Water Level Alerts</h6>
                                                    <p class="text-muted mb-0">Get notified when water level is low</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="waterLevelAlerts" checked>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="notification-option">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">Refill Completion</h6>
                                                    <p class="text-muted mb-0">Get notified when tank refill is complete</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="refillCompletion" checked>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="notification-group mb-4">
                                        <h6 class="notification-group-title">Account Notifications</h6>
                                        <div class="notification-option">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">System Maintenance</h6>
                                                    <p class="text-muted mb-0">Get notified about scheduled maintenance</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="systemMaintenance">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="notification-option">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">Tips & Updates</h6>
                                                    <p class="text-muted mb-0">Receive water conservation tips and system updates</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="tipsUpdates" checked>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="notification-group mb-4">
                                        <h6 class="notification-group-title">Notification Channels</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pushNotifications" checked>
                                                    <label class="form-check-label" for="pushNotifications">
                                                        <i class="bi bi-bell me-2"></i>Push Notifications
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="inAppNotifications" checked>
                                                    <label class="form-check-label" for="inAppNotifications">
                                                        <i class="bi bi-app-indicator me-2"></i>In-App Notifications
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-light me-2">Reset to Default</button>
                                        <button type="submit" class="btn btn-primary save-btn">
                                            <span class="btn-text">Save Preferences</span>
                                            <span class="btn-icon"><i class="bi bi-check-circle"></i></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="tab-pane fade" id="security">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Security Settings</h5>
                            </div>
                            <div class="card-body">
                                <form id="securityForm">
                                    <div class="section-title mb-3">Change Password</div>
                                    <div class="mb-4">
                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="currentPassword" placeholder="Current Password">
                                            <label for="currentPassword"><i class="bi bi-key me-2"></i>Current Password</label>
                                        </div>
                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="newPassword" placeholder="New Password">
                                            <label for="newPassword"><i class="bi bi-key-fill me-2"></i>New Password</label>
                                        </div>
                                        <div class="form-floating mb-3">
                                            <input type="password" class="form-control" id="confirmNewPassword" placeholder="Confirm New Password">
                                            <label for="confirmNewPassword"><i class="bi bi-key-fill me-2"></i>Confirm New Password</label>
                                        </div>
                                        <div class="password-strength mb-3">
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted">Password strength: <span id="passwordStrength">Weak</span></small>
                                        </div>
                                        <button type="submit" class="btn btn-primary" id="updatePasswordBtn">Update Password</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Devices Tab -->
                    <div class="tab-pane fade" id="devices">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Connected Devices</h5>
                            </div>
                            <div class="card-body" id="deviceListContainer">
                                <!-- Devices will be loaded here dynamically -->
                                <div class="text-center text-muted p-4" id="noDevicesMessage">
                                    <i class="bi bi-hdd-fill" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0">No devices linked yet.</p>
                                    <p><a href="setup.html">Link a new device</a> to get started.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configure Device Modal -->
    <div class="modal fade" id="configureDeviceModal" tabindex="-1" aria-labelledby="configureDeviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="configureDeviceModalLabel">Configure Device: <span id="modalDeviceName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info mb-4" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        To re-measure your drum height, ensure the water drum is **completely EMPTY** and the device's ultrasonic sensor is properly positioned at the top.
                    </div>

                    <div class="scan-section mb-4" id="modalScanSection">
                        <i class="fas fa-radar-chart icon-large text-primary" id="modalScanIcon"></i>
                        <h5 id="modalScanTitle">Ready to Scan</h5>
                        <p class="text-muted mb-4" id="modalScanDescription">
                            Click the button below to measure the total height of your empty drum.
                        </p>

                        <button class="btn btn-primary" id="modalScanButton">
                            <i class="fas fa-search me-2"></i>Scan Water Drum Now
                        </button>

                        <div class="hidden" id="modalScanningIndicator">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Scanning...</span>
                            </div>
                            <p class="mb-0">Scanning in progress... Awaiting measurement from device.</p>
                        </div>
                    </div>

                    <div class="hidden fade-in-up" id="modalScanResults">
                        <div class="water-level-display">
                            <h6 class="text-center mb-3">Measured Drum Height</h6>
                            <div class="water-tank-visual">
                                <div class="water-fill" id="modalWaterFill" style="height: 0%;"></div>
                                <div class="position-absolute w-100 text-center" style="bottom: -25px; font-size: 0.75rem; color: #6b7280;">
                                    Empty Drum
                                </div>
                            </div>
                            <div class="text-center">
                                <h3 class="text-primary mb-1" id="modalDrumHeightDisplay">0.0 cm</h3>
                                <p class="text-muted mb-3">total drum height</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" id="modalSaveDrumHeightButton">
                                        <i class="fas fa-check me-2"></i>Save Drum Height
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="modalRescanButton">
                                        <i class="fas fa-redo me-2"></i>Measure Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box Container -->
    <div id="messageBoxContainer"></div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
<script type="module">
        // Define embedUrlPrefix if it's not already defined by the environment
        const embedUrlPrefix = typeof window.__embed_url_prefix__ !== 'undefined' ? window.__embed_url_prefix__ : '';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Firebase configuration (same as in other files)
        const firebaseConfig = {
            apiKey: "AIzaSyCmFInEL6TMoD-9JwdPy-e9niNGGL5SjHA",
            authDomain: "hydrolink-d3c57.firebaseapp.com",
            databaseURL: "https://hydrolink-d3c57-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hydrolink-d3c57",
            storageBucket: "hydrolink-d3c57.firebasestorage.app",
            messagingSenderId: "770257381412",
            appId: "1:770257381412:web:a894f35854cb82274950b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentUser = null; // Store the current authenticated user object
        let currentUserId = null;
        let currentDeviceBeingConfigured = null; // Stores the deviceId of the device opened in the modal
        let isScanning = false; // Flag for modal scanning
        let unsubscribeModalDrumHeight = null; // To store the unsubscribe function for modal drum height listener

        // DOM Elements
        const emailInput = document.getElementById('email');
        const userAvatar = document.getElementById('userAvatar');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        const deviceListContainer = document.getElementById('deviceListContainer');
        const noDevicesMessage = document.getElementById('noDevicesMessage');

        // Modal DOM Elements
        const configureDeviceModal = new bootstrap.Modal(document.getElementById('configureDeviceModal'));
        const modalDeviceName = document.getElementById('modalDeviceName');
        const modalScanSection = document.getElementById('modalScanSection');
        const modalScanIcon = document.getElementById('modalScanIcon');
        const modalScanTitle = document.getElementById('modalScanTitle');
        const modalScanDescription = document.getElementById('modalScanDescription');
        const modalScanButton = document.getElementById('modalScanButton');
        const modalScanningIndicator = document.getElementById('modalScanningIndicator');
        const modalScanResults = document.getElementById('modalScanResults');
        const modalWaterFill = document.getElementById('modalWaterFill');
        const modalDrumHeightDisplay = document.getElementById('modalDrumHeightDisplay');
        const modalSaveDrumHeightButton = document.getElementById('modalSaveDrumHeightButton');
        const modalRescanButton = document.getElementById('modalRescanButton');

        // Message Box Function (replaces alert/confirm)
        function displayMessage(message, type = 'info', duration = 4000) {
            const messageBoxContainer = document.getElementById('messageBoxContainer');
            // Remove any existing message boxes to ensure only one is visible at a time
            const existingMessageBox = messageBoxContainer.querySelector('.message-box');
            if (existingMessageBox) {
                existingMessageBox.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} message-box`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `<div>${message}</div>`;
            messageBoxContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                currentUserId = user.uid;
                console.log("Settings: User signed in:", user.email || "Anonymous", "UID:", currentUserId);

                // Update Profile Tab
                emailInput.value = user.email || 'N/A';
                if (user.displayName) {
                    const names = user.displayName.split(' ');
                    document.getElementById('firstName').value = names[0] || '';
                    document.getElementById('lastName').value = names[names.length - 1] || '';
                    if (names.length > 2) {
                        document.getElementById('middleName').value = names.slice(1, -1).join(' ');
                    }
                }
                // Update avatar with user's initials/name
                const avatarName = user.displayName || user.email.split('@')[0] || 'JD';
                userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(avatarName)}&background=linear-gradient(45deg,4a9ff5,9c27b0)&color=fff&rounded=true&size=200`;

                // Load user profile data from Realtime Database (if exists)
                const userProfileRef = ref(database, `hydrolink/users/${currentUserId}/profile`);
                onValue(userProfileRef, (snapshot) => {
                    const profileData = snapshot.val();
                    if (profileData) {
                        document.getElementById('firstName').value = profileData.firstName || '';
                        document.getElementById('middleName').value = profileData.middleName || '';
                        document.getElementById('lastName').value = profileData.lastName || '';
                        document.getElementById('phone').value = profileData.phone || '';
                        document.getElementById('gender').value = profileData.gender || 'male'; // Default to male if not set
                        document.getElementById('birthdate').value = profileData.birthdate || '';
                        document.getElementById('bio').value = profileData.bio || '';
                    }
                }, { onlyOnce: true }); // Load once on page load

                // Load and display linked devices
                loadLinkedDevices();

            } else {
                currentUser = null;
                currentUserId = null;
                console.log("Settings: User signed out. Redirecting to login.");
                if (!window.location.pathname.endsWith('auth.html')) {
                    window.location.href = embedUrlPrefix + '/auth.html';
                }
            }
        });
        

        // --- Profile Tab Functionality ---
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                displayMessage("You must be logged in to update your profile.", "danger");
                return;
            }

            const firstName = document.getElementById('firstName').value.trim();
            const middleName = document.getElementById('middleName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const gender = document.getElementById('gender').value;
            const birthdate = document.getElementById('birthdate').value;
            const bio = document.getElementById('bio').value.trim();

            const profileData = {
                firstName,
                middleName,
                lastName,
                phone,
                gender,
                birthdate,
                bio,
                lastUpdated: Date.now()
            };

            const saveProfileBtn = document.getElementById('saveProfileBtn');
            saveProfileBtn.disabled = true;
            saveProfileBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';

            try {
                await set(ref(database, `hydrolink/users/${currentUserId}/profile`), profileData);
                // Also update displayName in Firebase Auth if names are provided
                if (firstName || lastName) {
                    const fullName = `${firstName} ${middleName ? middleName + ' ' : ''}${lastName}`.trim();
                    await currentUser.updateProfile({ displayName: fullName });
                    console.log("Firebase Auth profile updated with displayName:", fullName);
                }
                displayMessage("Profile updated successfully!", "success");
            } catch (error) {
                console.error("Error updating profile:", error);
                displayMessage(`Failed to update profile: ${error.message}`, "danger");
            } finally {
                saveProfileBtn.disabled = false;
                saveProfileBtn.innerHTML = '<span class="btn-text">Save Changes</span><span class="btn-icon"><i class="bi bi-check-circle"></i></span>';
            }
        });


        // --- Security Tab Functionality (Change Password) ---
        updatePasswordBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                displayMessage("You must be logged in to change your password.", "danger");
                return;
            }
            if (!currentUser.email) {
                displayMessage("Cannot change password for this account type. Email is not associated.", "danger");
                return;
            }

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                displayMessage("Please fill in all password fields.", "danger");
                return;
            }
            if (newPassword !== confirmNewPassword) {
                displayMessage("New passwords do not match.", "danger");
                return;
            }
            if (newPassword.length < 6) {
                displayMessage("New password must be at least 6 characters long.", "danger");
                return;
            }

            updatePasswordBtn.disabled = true;
            updatePasswordBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Updating...';

            try {
                // Re-authenticate user before changing password for security
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                
                await updatePassword(currentUser, newPassword);
                displayMessage("Password updated successfully!", "success");
                // Clear password fields
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
            } catch (error) {
                console.error("Error updating password:", error);
                let errorMessage = `Failed to update password: ${error.message}`; // Display Firebase error message
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect current password.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log in again to update your password (for security reasons).";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "The new password is too weak. Please choose a stronger one.";
                }
                displayMessage(errorMessage, "danger");
            } finally {
                updatePasswordBtn.disabled = false;
                updatePasswordBtn.innerHTML = 'Update Password';
            }
        });

        // --- Devices Tab Functionality ---
        async function loadLinkedDevices() {
            if (!currentUserId) {
                console.warn("No current user ID to load linked devices.");
                deviceListContainer.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-hdd-fill" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">Please log in to view your linked devices.</p>
                    </div>
                `;
                return;
            }

            const userDevicesRef = ref(database, `hydrolink/users/${currentUserId}/devices`);
            onValue(userDevicesRef, (snapshot) => { // Use onValue for real-time updates
                const devices = snapshot.val();
                deviceListContainer.innerHTML = ''; // Clear existing list

                if (devices) {
                    noDevicesMessage.classList.add('d-none'); // Hide "No devices" message
                    Object.entries(devices).forEach(([deviceId, deviceData]) => {
                        const deviceItem = document.createElement('div');
                        deviceItem.className = 'device-item';
                        deviceItem.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="device-icon me-3">
                                    <i class="bi bi-droplet-fill"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">${deviceData.deviceName || `HydroLink Device (${deviceId.substring(0, 6)}...)`}</h6>
                                    <p class="text-muted mb-0">MAC: ${deviceData.macAddress || 'N/A'}</p>
                                    <p class="text-muted mb-0">Connected since: ${deviceData.linkedAt ? new Date(deviceData.linkedAt).toLocaleDateString() : 'N/A'}</p>
                                    <span class="badge bg-success">Online</span> </div>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary me-2 configure-btn" data-bs-toggle="modal" data-bs-target="#configureDeviceModal" data-device-id="${deviceId}" data-device-name="${deviceData.deviceName || `HydroLink Device (${deviceId.substring(0, 6)}...)`}">Configure</button>
                                <button type="button" class="btn btn-sm btn-outline-danger disconnect-btn" data-device-id="${deviceId}">Disconnect</button>
                            </div>
                        `;
                        deviceListContainer.appendChild(deviceItem);
                    });

                    // Add event listeners to newly created disconnect buttons
                    document.querySelectorAll('.disconnect-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const deviceIdToDisconnect = e.target.dataset.deviceId;
                            confirmDisconnect(deviceIdToDisconnect);
                        });
                    });

                    // Event listener for when the modal is shown
                    document.getElementById('configureDeviceModal').addEventListener('show.bs.modal', async (event) => {
                        const button = event.relatedTarget; // Button that trigger Informaed the modal
                        currentDeviceBeingConfigured = button.getAttribute('data-device-id');
                        const deviceName = button.getAttribute('data-device-name');
                        modalDeviceName.textContent = deviceName;

                        // Reset modal UI to initial scan state
                        resetModalScanSection();

                        // Load existing drum height for the device
                        if (currentDeviceBeingConfigured) {
                            const deviceSettingsRef = ref(database, `hydrolink/devices/${currentDeviceBeingConfigured}/settings/drumHeightCm`);
                            const snapshot = await get(deviceSettingsRef);
                            const currentHeight = snapshot.val();
                            if (currentHeight !== null && currentHeight > 0) { // Check for null and positive value
                                modalDrumHeightDisplay.textContent = `${currentHeight.toFixed(1)} cm`;
                                modalScanSection.classList.add('completed');
                                modalScanResults.classList.remove('hidden');
                                modalScanIcon.className = 'fas fa-check-circle icon-large text-success';
                                modalScanTitle.textContent = 'Current Drum Height';
                                modalScanDescription.textContent = 'This device is already calibrated. You can re-measure if needed.';
                                modalScanButton.style.display = 'none'; // Hide scan button if already measured
                                modalSaveDrumHeightButton.textContent = 'Update Drum Height'; // Change button text
                            } else {
                                modalDrumHeightDisplay.textContent = '0.0 cm';
                                modalSaveDrumHeightButton.textContent = 'Save Drum Height';
                                modalScanButton.style.display = 'inline-block'; // Ensure scan button is visible
                            }
                        }
                    });

                } else {
                    noDevicesMessage.classList.remove('d-none'); // Show "No devices" message
                    deviceListContainer.appendChild(noDevicesMessage); // Ensure it's in the container
                }
            });
        }

        async function confirmDisconnect(deviceId) {
            // Using displayMessage for confirmation, which is a simple alert replacement.
            // For a more robust solution, you'd use a custom modal.
            const confirmAction = confirm("Are you sure you want to disconnect this device? This action cannot be undone.");
            if (!confirmAction) {
                return;
            }

            try {
                // 1. Remove device from user's linked devices
                await remove(ref(database, `hydrolink/users/${currentUserId}/devices/${deviceId}`));

                // 2. Remove user from device's linkedUsers list
                await remove(ref(database, `hydrolink/devices/${deviceId}/linkedUsers/${currentUserId}`));

                // 3. If this was the primary device stored in localStorage, remove it
                const storedDeviceId = localStorage.getItem(`hydrolink_device_id_${currentUserId}`);
                if (storedDeviceId === deviceId) {
                    localStorage.removeItem(`hydrolink_device_id_${currentUserId}`);
                    console.log("Primary device ID removed from localStorage.");
                }

                displayMessage("Device disconnected successfully!", "success");
                // The onValue listener in loadLinkedDevices will automatically update the UI
            } catch (error) {
                console.error("Error disconnecting device:", error);
                displayMessage(`Failed to disconnect device: ${error.message}`, "danger");
            }
        }

        // --- Modal Scan Logic (adapted from setup.html) ---

        modalScanButton.addEventListener('click', triggerModalDrumMeasurement);
        modalRescanButton.addEventListener('click', resetModalScanSection);
        modalSaveDrumHeightButton.addEventListener('click', saveModalDrumHeight);

        // Add this listener to reset modal state when it's hidden
        document.getElementById('configureDeviceModal').addEventListener('hidden.bs.modal', function () {
            resetModalScanSection();
            // Also unsubscribe the listener if it's still active when modal closes
            if (unsubscribeModalDrumHeight) {
                unsubscribeModalDrumHeight();
                unsubscribeModalDrumHeight = null; // Clear the reference
            }
        });

        async function triggerModalDrumMeasurement() {
            if (!currentUserId || !currentDeviceBeingConfigured) {
                displayMessage("Authentication or Device ID missing. Please log in and ensure device is linked.", "danger");
                return;
            }

            if (isScanning) return; // Prevent multiple scans

            isScanning = true;
            modalScanButton.style.display = 'none';
            modalScanningIndicator.classList.remove('hidden');
            modalScanSection.classList.add('scanning');
            modalScanIcon.className = 'fas fa-spinner fa-spin icon-large text-warning';
            modalScanTitle.textContent = 'Measuring Drum Height';
            modalScanDescription.textContent = 'Please wait while your Hydrolink device measures the total height of your empty water drum...';
            modalScanResults.classList.add('hidden'); // Hide results during scan

            try {
                // Set the flag in Firebase to true to trigger measurement on ESP32
                const measureDrumFlagRef = ref(database, `hydrolink/devices/${currentDeviceBeingConfigured}/settings/measureDrum`);
                await set(measureDrumFlagRef, true);
                console.log("Requested drum measurement from ESP32 via Firebase for device:", currentDeviceBeingConfigured);

                // --- ADD THE 8-SECOND DELAY HERE ---
                console.log("Waiting 8 seconds for the ESP32 to complete measurement...");
                await new Promise(resolve => setTimeout(resolve, 8000)); // 8-second delay

                let receivedHeight = 0; // To store the height from Firebase
                let measurementFirebasePromise = new Promise((resolve, reject) => { // Added reject for timeout
                    const drumHeightRef = ref(database, `hydrolink/devices/${currentDeviceBeingConfigured}/settings/drumHeightCm`);
                    let timeoutId; // To store the timeout ID

                    // Function to clean up the listener and timeout
                    const cleanup = () => {
                        if (unsubscribeModalDrumHeight) {
                            unsubscribeModalDrumHeight();
                            unsubscribeModalDrumHeight = null;
                        }
                        clearTimeout(timeoutId);
                    };

                    // Set a timeout to reject the promise if no valid measurement is received within a reasonable time
                    // (e.g., 20 seconds, adjust if needed. This is separate from the initial 8s delay)
                    timeoutId = setTimeout(() => {
                        cleanup();
                        reject(new Error("Measurement timeout: No valid drum height received from device."));
                    }, 20000); // Give it up to 20 seconds to receive the value after the initial 8s delay

                    // Unsubscribe any previous listener to avoid multiple active listeners
                    if (unsubscribeModalDrumHeight) {
                        unsubscribeModalDrumHeight();
                    }

                    unsubscribeModalDrumHeight = onValue(drumHeightRef, (snapshot) => {
                        const heightCm = snapshot.val();
                        if (heightCm !== null && typeof heightCm === 'number' && heightCm > 0) {
                            receivedHeight = heightCm;
                            cleanup(); // Clean up listener and timeout
                            resolve(heightCm); // Resolve the promise with the valid height
                        } else {
                            console.log("Received invalid or null height from Firebase, waiting for valid measurement...");
                        }
                    }, (error) => {
                        // Handle potential errors from Firebase listener itself
                        cleanup();
                        reject(error);
                    });
                });

                // Await the measurement promise directly after the 8-second delay
                const height = await measurementFirebasePromise;

                if (isScanning) { // Ensure we are still in scanning mode
                    completeModalDrumHeightScan(height);
                }

            } catch (error) {
                console.error("Error during drum measurement process:", error);
                // Check if it's a timeout error specifically
                if (error.message.includes("Measurement timeout")) {
                    displayMessage(`Measurement failed: ${error.message}. Please ensure the device is connected and functioning correctly.`, "danger");
                } else {
                    displayMessage(`Measurement failed: ${error.message || "An unexpected error occurred."}`, "danger");
                }
                resetModalScanSection();
            } finally {
                // Ensure isScanning is set to false regardless of success or failure
                isScanning = false;
            }
        }

        function completeModalDrumHeightScan(heightCm) {
            isScanning = false; // Reset scanning flag
            modalScanSection.classList.remove('scanning');
            modalScanSection.classList.add('completed');
            modalScanningIndicator.classList.add('hidden');
            modalScanIcon.className = 'fas fa-check-circle icon-large text-success';
            modalScanTitle.textContent = 'Drum Height Measured';
            modalScanDescription.textContent = 'Empty drum height measurement successful!';

            modalScanResults.classList.remove('hidden');
            modalDrumHeightDisplay.textContent = `${heightCm.toFixed(1)} cm`;
            modalWaterFill.style.height = '0%'; // Ensure water fill is 0% for empty drum measurement visual
            modalSaveDrumHeightButton.textContent = 'Save Drum Height'; // Reset button text
            modalSaveDrumHeightButton.focus(); // Focus the save button for better UX
        }

        function resetModalScanSection() {
            isScanning = false;
            modalScanSection.classList.remove('completed');
            modalScanSection.classList.remove('scanning');
            modalScanResults.classList.add('hidden');
            modalScanButton.style.display = 'inline-block'; // Show the scan button again
            modalScanningIndicator.classList.add('hidden'); // Hide scanning indicator
            modalScanIcon.className = 'fas fa-radar-chart icon-large text-primary';
            modalScanTitle.textContent = 'Ready to Scan';
            modalScanDescription.textContent = 'Click the button below to measure the total height of your empty drum.';
            modalDrumHeightDisplay.textContent = '0.0 cm'; // Reset displayed height
            modalSaveDrumHeightButton.textContent = 'Save Drum Height'; // Reset button text
        }

        async function saveModalDrumHeight() {
            if (!currentUserId || !currentDeviceBeingConfigured) {
                displayMessage("Authentication or Device ID missing. Cannot save drum height.", "danger");
                return;
            }

            const drumHeight = parseFloat(modalDrumHeightDisplay.textContent);
            if (drumHeight <= 0) {
                displayMessage("Please measure a valid drum height before saving.", "warning");
                return;
            }

            modalSaveDrumHeightButton.disabled = true;
            modalSaveDrumHeightButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';

            try {
                const deviceSettingsRef = ref(database, `hydrolink/devices/${currentDeviceBeingConfigured}/settings`);
                // Use update to only change drumHeightCm, preserving other settings
                await set(deviceSettingsRef, { drumHeightCm: drumHeight }, { merge: true });
                displayMessage("Drum height updated successfully!", "success");
                configureDeviceModal.hide(); // Close modal on success
            } catch (error) {
                console.error("Error saving drum height:", error);
                displayMessage(`Failed to save drum height: ${error.message}`, "danger");
            } finally {
                modalSaveDrumHeightButton.disabled = false;
                modalSaveDrumHeightButton.innerHTML = '<i class="fas fa-check me-2"></i>Save Drum Height';
            }
        }


        // Complete Philippine address data with proper structure
        const addressData = {
            ncr: {
                name: "National Capital Region",
                provinces: {
                    "Metro Manila": {
                        cities: {
                            "Manila": {
                                barangays: ["Barangay 1", "Barangay 2", "Barangay 3", "Malate", "Ermita", "Intramuros"],
                                zipcode: "1000"
                            },
                            "Quezon City": {
                                barangays: ["Bagong Pag-asa", "Diliman", "Loyola Heights", "Tandang Sora", "Project 8", "Commonwealth"],
                                zipcode: "1100"
                            },
                            "Caloocan": {
                                barangays: ["Barangay 1", "Barangay 2", "Barangay 3", "Grace Park", "Monumento"],
                                zipcode: "1400"
                            },
                            "Makati": {
                                barangays: ["Poblacion", "Bel-Air", "San Lorenzo", "Salcedo Village", "Legazpi Village"],
                                zipcode: "1200"
                            }
                        }
                    }
                }
            },
            region9: {
                name: "Region IX - Zamboanga Peninsula",
                provinces: {
                    "Zamboanga del Norte": {
                        cities: {
                            "Dipolog": {
                                barangays: ["Central", "Estaka", "Galas", "Miputak", "Olingan", "Turno"],
                                zipcode: "7100"
                            },
                            "Dapitan": {
                                barangays: ["Bagting", "Ba-ao", "Canlucani", "Dawo", "Ilaya", "Maria Uray"],
                                zipcode: "7101"
                            },
                            "Rizal": {
                                barangays: ["Poblacion", "Salug", "Sianib", "Tigbao", "Dumalinao"],
                                zipcode: "7105"
                            }
                        }
                    },
                    "Zamboanga del Sur": {
                        cities: {
                            "Zamboanga City": {
                                barangays: ["Arena Blanco", "Ayala", "Baliwasan", "Boalan", "Buenavista", "Cabatangan", "Cacao", "Calarian", "Camino Nuevo", "Campo Islam", "Capisan", "Caragasan", "Catalunan Grande", "Catalunan Pequeo", "Culianan", "Divisoria", "Don Alfaro", "Guiwan", "La Paz", "Latuan", "Lubigan", "Lunzuran", "Maasin", "Malagutay", "Mampang", "Mariki", "Mercedes", "Pasonanca", "Putik", "Quiniput", "Rio Hondo", "Salaan", "San Jose Cawa-cawa", "San Jose Gusu", "San Roque", "Santa Barbara", "Santa Catalina", "Santa Maria", "Santo Nio", "Sibulao", "Sinunuc", "Tagasilay", "Taguiti", "Talabaan", "Talon-talon", "Tetuan", "Tictapul", "Tigbalabag", "Tugbungan", "Tumaga", "Victoria", "Zone I (Poblacion)", "Zone II (Poblacion)", "Zone III (Poblacion)", "Zone IV (Poblacion)"],
                                zipcode: "7000"
                            },
                            "Pagadian": {
                                barangays: ["Bogo", "Bomba", "Bungiao", "Danlugan", "Dumagoc", "Gatas", "Gubac", "Kagawasan", "Kawit", "Lala", "Lenienza", "Lizon Valley", "Lower Sibatang", "Lumad", "Macasing", "Muricay", "Napolan", "Pedulonan", "San Francisco", "San Pedro", "San Vicente", "Santa Lucia", "Santa Maria", "Santiago", "Tiguma", "Tawagan Sur", "Upper Sibatang", "White Beach"],
                                zipcode: "7016"
                            },
                            "Molave": {
                                barangays: ["Poblacion", "Bagong Tudela", "Lapu-lapu", "Liberty", "Lumbog", "Tomalig"],
                                zipcode: "7023"
                            }
                        }
                    },
                    "Zamboanga Sibugay": {
                        cities: {
                            "Ipil": {
                                barangays: ["Poblacion", "Apokon", "Tenan", "Sandayong", "Crossing Rubber"],
                                zipcode: "7001"
                            },
                            "Titay": {
                                barangays: ["Poblacion", "Kauswagan", "Little Baguio", "Pangi"],
                                zipcode: "7004"
                            }
                        }
                    }
                }
            },
            region10: {
                name: "Region X - Northern Mindanao",
                provinces: {
                    "Bukidnon": {
                        cities: {
                            "Malaybalay": {
                                barangays: ["Poblacion", "Aglayan", "Bangcud", "Casisang", "Dalwangan", "Laguitas", "Managok", "Simaya", "Violeta"],
                                zipcode: "8700"
                            },
                            "Valencia": {
                                barangays: ["Poblacion", "Bagontaas", "Banlag", "Catumbalon", "Lumbayao", "Mailag", "San Carlos"],
                                zipcode: "8709"
                            }
                        }
                    },
                    "Misamis Oriental": {
                        cities: {
                            "Cagayan de Oro": {
                                barangays: ["Barangay 1", "Barangay 2", "Barangay 3", "Barangay 4", "Barangay 5", "Agusan", "Balulang", "Bayabas", "Bayanga", "Besigan", "Bonbon", "Bugo", "Bulua", "Camaman-an", "Carmen", "Consolacion", "F.S. Catanico", "Gusa", "Iponan", "Kauswagan", "Lapasan", "Lumbia", "Macabalan", "Macasandig", "Nazareth", "Pagatpat", "Patag", "Puerto", "Tablon", "Tagpangi", "Taguanao", "Tignapoloan", "Tuburan"],
                                zipcode: "9000"
                            },
                            "El Salvador": {
                                barangays: ["Poblacion", "Hinigdaan", "Misamis", "Caimbang", "Maitum"],
                                zipcode: "9003"
                            }
                        }
                    },
                    "Camiguin": {
                        cities: {
                            "Mambajao": {
                                barangays: ["Poblacion", "Agoho", "Anito", "Balbagon", "Benhaan", "Bugong", "Cabua-an", "Catagman", "Gitagum"],
                                zipcode: "9100"
                            }
                        }
                    }
                }
            },
            region7: {
                name: "Region VII - Central Visayas",
                provinces: {
                    "Cebu": {
                        cities: {
                            "Cebu City": {
                                barangays: ["Apas", "Banilad", "Basak San Nicolas", "Bulacao", "Busay", "Capitol Site", "Carreta", "Cogon Pardo", "Day-as", "Guadalupe", "Inayawan", "IT Park", "Kamagayan", "Kamputhaw", "Kasambagan", "Kinasang-an", "Labangon", "Lahug", "Lorega San Miguel", "Mabolo", "Malubog", "Pahina Central", "Pahina San Nicolas", "Poblacion Pardo", "Poblacion Villa San Nicolas", "Punta Princesa", "Quiot", "Sambag I", "Sambag II", "San Nicolas Proper", "Santa Cruz", "Santo Nio", "Sirao", "Suba", "T. Padilla", "Talamban", "Tejero", "Tinago", "Tisa", "Zapatera"],
                                zipcode: "6000"
                            },
                            "Lapu-Lapu": {
                                barangays: ["Poblacion", "Agus", "Bankal", "Basak", "Buaya", "Calawisan", "Canjulao", "Caw-oy", "Gun-ob", "Ibo", "Looc", "Mactan", "Marigondon", "Pajac", "Pajo", "Pusok", "Subabasbas", "Talima", "Tingo", "Tugbongan"],
                                zipcode: "6015"
                            }
                        }
                    },
                    "Bohol": {
                        cities: {
                            "Tagbilaran": {
                                barangays: ["Poblacion 1", "Poblacion 2", "Poblacion 3", "Bool", "Cabawan", "Cogon", "Dampas", "Manga", "Mansasa", "San Isidro", "Talbao", "Taloto", "Ubujan"],
                                zipcode: "6300"
                            }
                        }
                    }
                }
            }
        };

        // Get form elements
        const regionSelect = document.getElementById('region');
        const provinceSelect = document.getElementById('province');
        const citySelect = document.getElementById('city');
        const barangaySelect = document.getElementById('barangay');
        const zipcodeSelect = document.getElementById('zipcode');

        // Helper function to populate a select element
        function populateSelect(selectElement, options = []) {
            // Clear existing options except the first placeholder
            selectElement.innerHTML = `<option value="" selected disabled>Select ${selectElement.id.charAt(0).toUpperCase() + selectElement.id.slice(1).replace('zipcode', 'Zipcode')}</option>`;
            
            if (options && options.length > 0) {
                selectElement.disabled = false;
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });
            } else {
                selectElement.disabled = true;
            }
        }

        // Clear and disable dependent selects
        function clearDependentSelects(...selects) {
            selects.forEach(select => {
                select.innerHTML = `<option value="" selected disabled>Select ${select.id.charAt(0).toUpperCase() + select.id.slice(1).replace('zipcode', 'Zipcode')}</option>`;
                select.disabled = true;
            });
        }

        // Region change handler
        regionSelect.addEventListener('change', function() {
            const selectedRegion = this.value;
            console.log('Region selected:', selectedRegion);
            
            // Clear dependent selects
            clearDependentSelects(provinceSelect, citySelect, barangaySelect, zipcodeSelect);
            
            if (selectedRegion && addressData[selectedRegion]) {
                const provinces = Object.keys(addressData[selectedRegion].provinces);
                populateSelect(provinceSelect, provinces);
                console.log('Provinces loaded:', provinces);
            }
        });

        // Province change handler
        provinceSelect.addEventListener('change', function() {
            const selectedRegion = regionSelect.value;
            const selectedProvince = this.value;
            console.log('Province selected:', selectedProvince);
            
            // Clear dependent selects
            clearDependentSelects(citySelect, barangaySelect, zipcodeSelect);
            
            if (selectedRegion && selectedProvince && addressData[selectedRegion].provinces[selectedProvince]) {
                const cities = Object.keys(addressData[selectedRegion].provinces[selectedProvince].cities);
                populateSelect(citySelect, cities);
                console.log('Cities loaded:', cities);
            }
        });

        // City change handler
        citySelect.addEventListener('change', function() {
            const selectedRegion = regionSelect.value;
            const selectedProvince = provinceSelect.value;
            const selectedCity = this.value;
            console.log('City selected:', selectedCity);
            
            // Clear dependent selects
            clearDependentSelects(barangaySelect, zipcodeSelect);
            
            if (selectedRegion && selectedProvince && selectedCity && 
                addressData[selectedRegion].provinces[selectedProvince].cities[selectedCity]) {
                
                const cityData = addressData[selectedRegion].provinces[selectedProvince].cities[selectedCity];
                
                // Populate barangays
                const barangays = cityData.barangays || [];
                populateSelect(barangaySelect, barangays);
                console.log('Barangays loaded:', barangays.length, 'items');
                
                // Populate zipcode
                if (cityData.zipcode) {
                    populateSelect(zipcodeSelect, [cityData.zipcode]);
                    console.log('Zipcode loaded:', cityData.zipcode);
                }
            }
        });

        // Address form submission handler
        document.getElementById('addressForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                region: regionSelect.value,
                province: provinceSelect.value,
                city: citySelect.value,
                barangay: barangaySelect.value,
                streetName: document.getElementById('streetName').value,
                zipcode: zipcodeSelect.value,
                addressNotes: document.getElementById('addressNotes').value
            };
            
            console.log('Address form submitted with data:', formData);
            
            if (!currentUserId) {
                displayMessage("You must be logged in to save your address.", "danger");
                return;
            }

            // Save address to Firebase
            const addressDataToSave = {
                region: formData.region,
                province: formData.province,
                city: formData.city,
                barangay: formData.barangay,
                streetName: formData.streetName,
                zipcode: formData.zipcode,
                addressNotes: formData.addressNotes,
                lastUpdated: Date.now()
            };

            const saveAddressBtn = e.target.querySelector('button[type="submit"]');
            saveAddressBtn.disabled = true;
            saveAddressBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Saving...';

            set(ref(database, `hydrolink/users/${currentUserId}/address`), addressDataToSave)
                .then(() => {
                    displayMessage("Address saved successfully!", "success");
                })
                .catch((error) => {
                    console.error("Error saving address:", error);
                    displayMessage(`Failed to save address: ${error.message}`, "danger");
                })
                .finally(() => {
                    saveAddressBtn.disabled = false;
                    saveAddressBtn.innerHTML = '<span class="btn-text">Save Address</span><span class="btn-icon"><i class="bi bi-check-circle"></i></span>';
                });
        });
    </script>
</body>
</html>
