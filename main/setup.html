<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrolink - Device Setup</title>
    <link rel="icon" type="image/x-icon" href="/main/materials/hydrolink-logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #2563eb;
            --secondary-blue: #1e40af;
            --light-blue: #dbeafe;
            --accent-teal: #0891b2;
            --accent-green: #059669;
            --warning-orange: #ea580c;
            --text-dark: #1f2937;
            --text-light: #6b7280;
        }

        body {
            background: linear-gradient(135deg, var(--light-blue) 0%, #f8fafc 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        #adv-settings {
        color: #1f2937 !important;
        }

        .hero-section {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }

        .setup-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.1);
            border: 2px solid var(--light-blue);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .setup-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.15);
        }

        .step-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-teal) 100%);
            color: white;
            padding: 1.5rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        }

        .step-number {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-teal) 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .btn-success-custom {
            background: linear-gradient(135deg, var(--accent-green) 0%, #10b981 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn {
            color: #FAFAFA;
        }

        .btn-success-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
        }

        .instruction-item {
            background: #f8fafc;
            border-left: 4px solid var(--primary-blue);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 10px 10px 0;
            transition: all 0.3s ease;
        }

        .instruction-item:hover {
            background: var(--light-blue);
            transform: translateX(5px);
        }

        .scan-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px dashed var(--accent-teal);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .scan-section.scanning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: var(--warning-orange);
            animation: pulse 2s infinite;
        }

        .scan-section.completed {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: var(--accent-green);
        }

        .water-level-display {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .water-tank-visual {
            width: 100px;
            height: 200px;
            border: 3px solid var(--primary-blue);
            border-radius: 10px;
            position: relative;
            margin: 0 auto 1rem;
            overflow: hidden;
            background: #f8fafc;
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, var(--accent-teal) 0%, var(--primary-blue) 100%);
            transition: height 1s ease;
            border-radius: 0 0 7px 7px;
        }

        .threshold-config {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .range-slider {
            margin: 1rem 0;
        }

        .range-slider input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--light-blue);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
        }

        .range-slider input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            border: none;
        }

        .progress-indicator {
            background: var(--light-blue);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-teal) 100%);
            height: 100%;
            transition: width 0.5s ease;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-badge.connected {
            background: #dcfce7;
            color: var(--accent-green);
        }

        .status-badge.disconnected {
            background: #fee2e2;
            color: #ef4444; /* Red color for disconnected */
        }

        .status-badge.scanning {
            background: #fef3c7;
            color: var(--warning-orange);
        }

        .status-badge.ready {
            background: var(--light-blue);
            color: var(--primary-blue);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .icon-large {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>

</head>
<body>

    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-12 text-center">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-cogs me-3"></i>Device Setup
                    </h1>
                    <p class="lead mb-0">Complete the physical installation of your Hydrolink system</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="progress-indicator">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>

        <div class="row mb-5" id="physicalInstallationSection">
            <div class="col-12">
                <div class="card setup-card">
                    <div class="card-body p-4">
                        <div class="step-header">
                            <div class="d-flex align-items-center">
                                <div class="step-number">1</div>
                                <div>
                                    <h3 class="mb-1">Physical Installation</h3>
                                    <p class="mb-0 opacity-75">Connect your device components</p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-8">
                                <h5 class="mb-3">
                                    <i class="fas fa-tools text-primary me-2"></i>Installation Instructions
                                </h5>

                                <div class="instruction-item">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <i class="fas fa-faucet text-primary" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">Connect Device to Faucet</h6>
                                            <p class="mb-0 text-muted">Attach the Hydrolink device directly to your water faucet using the provided connector. Ensure a tight, leak-proof connection.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="instruction-item">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <i class="fas fa-grip-lines text-primary" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">Connect Hose to Water Drum</h6>
                                            <p class="mb-0 text-muted">Run the water hose from the device output to your water storage drum. Make sure the hose reaches the bottom of the drum.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="instruction-item">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <i class="fas fa-satellite-dish text-primary" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-2">Place Ultrasonic Sensor</h6>
                                            <p class="mb-0 text-muted">Position the ultrasonic sensor at the top of your water drum, pointing downward. Secure it firmly to prevent movement.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="text-center">
                                    <i class="fas fa-drum icon-large text-primary"></i>
                                    <h5 class="text-primary">Installation Diagram</h5>
                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Ensure all connections are secure before proceeding to the next step.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-primary-custom btn-lg" onclick="window.location.href='index.html'">
                                <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                            </button>
                            <button class="btn btn-primary-custom btn-lg" id="proceedToMacAddressBtn">
                                <i class="fas fa-arrow-right me-2"></i>Proceed to Device Linking
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5 hidden" id="macAddressSection">
            <div class="col-12">
                <div class="card setup-card">
                    <div class="card-body p-4">
                        <div class="step-header">
                            <div class="d-flex align-items-center">
                                <div class="step-number">2</div>
                                <div>
                                    <h3 class="mb-1">Identify Your Device</h3>
                                    <p class="mb-0 opacity-75">Enter your Hydrolink device's unique MAC Address</p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-8 offset-lg-2 text-center">
                                <p class="text-muted mb-4">
                                    Please connect your Hydrolink device to power. Its unique MAC Address will be displayed on the **Serial Monitor** if connected to your computer, or on the **OLED screen** if it has one. Enter it below to link your account to this device.
                                </p>
                                <div class="mb-3">
                                    <label for="macAddressInput" class="form-label">Device MAC Address</label>
                                    <input type="text" class="form-control" id="macAddressInput" placeholder="e.g., 6C:C8:40:55:E0:70" pattern="^([0-9A-Fa-f]{2}[-: ]){5}([0-9A-Fa-f]{2})$" required>
                                    <div class="invalid-feedback">
                                        Please enter a valid MAC address (e.g., XX:XX:XX:XX:XX:XX or XX-XX-XX-XX-XX-XX).
                                    </div>
                                </div>
                                <div id="macAddressStatus" class="mb-3">
                                    </div>
                                <button class="btn btn-primary-custom btn-lg" id="confirmMacAddressBtn">
                                    <i class="fas fa-link me-2"></i>Link Device
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5 hidden" id="scanDrumSection">
            <div class="col-lg-6">
                <div class="card setup-card">
                    <div class="card-body p-4">
                        <div class="step-header">
                            <div class="d-flex align-items-center">
                                <div class="step-number">3</div>
                                <div>
                                    <h3 class="mb-1">Scan Water Drum</h3>
                                    <p class="mb-0 opacity-75">Measure total drum height</p>
                                </div>
                            </div>
                        </div>

                        <div class="scan-section" id="scanSection">
                            <i class="fas fa-radar-chart icon-large text-primary" id="scanIcon"></i>
                            <h5 id="scanTitle">Ready to Scan</h5>
                            <p class="text-muted mb-4" id="scanDescription">
                                Make sure your water drum is EMPTY, then click the button below to measure the total height of your drum.
                            </p>

                            <button class="btn btn-primary-custom btn-lg" id="scanButton">
                                <i class="fas fa-search me-2"></i>Scan Water Drum Now
                            </button>

                            <div class="hidden" id="scanningIndicator">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Scanning...</span>
                                </div>
                                <p class="mb-0">Scanning in progress... Awaiting measurement from device.</p>
                            </div>
                        </div>

                        <div class="hidden fade-in-up" id="scanResults">
                            <div class="water-level-display">
                                <h6 class="text-center mb-3">Drum Height Measurement</h6>
                                <div class="water-tank-visual">
                                    <div class="water-fill" id="waterFill"></div>
                                    <div class="position-absolute w-100 text-center" style="bottom: -25px; font-size: 0.75rem; color: #6b7280;">
                                        Empty Drum
                                    </div>
                                </div>
                                <div class="text-center">
                                    <h3 class="text-primary mb-1" id="drumHeightDisplay">0.0 cm</h3>
                                    <p class="text-muted mb-3">total drum height</p>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success-custom" id="proceedButton">
                                            <i class="fas fa-arrow-right me-2"></i>Proceed to Configuration
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" id="rescanButton">
                                            <i class="fas fa-redo me-2"></i>Measure Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card setup-card">
                    <div class="card-body p-4">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle text-info me-2"></i>Scanning Information
                        </h5>

                        <div class="alert alert-info">
                            <h6 class="alert-heading">How it works</h6>
                            <p class="mb-0">The ultrasonic sensor on your Hydrolink device measures the distance from the top of the drum to the bottom, calculating the total drum height for calibration. This value will be uploaded to the cloud.</p>
                        </div>

                        <div class="alert alert-warning">
                            <h6 class="alert-heading">Important Notes</h6>
                            <ul class="mb-0">
                                <li>Ensure the drum is completely EMPTY for an accurate measurement.</li>
                                <li>The sensor must be positioned at the very top of the drum.</li>
                                <li>Keep the area quiet during measurement to avoid interference.</li>
                                <li>This step calibrates the system for accurate water level readings.</li>
                            </ul>
                        </div>

                        <div class="alert alert-success">
                            <h6 class="alert-heading">Troubleshooting</h6>
                            <p class="mb-0">If scanning fails or the device appears offline, double-check the sensor connections and ensure your Hydrolink device is powered on and connected to Wi-Fi. You can then try again.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5 hidden" id="configurationSection">
            <div class="col-12">
                <div class="card setup-card">
                    <div class="card-body p-4">
                        <div class="step-header">
                            <div class="d-flex align-items-center">
                                <div class="step-number">4</div>
                                <div>
                                    <h3 class="mb-1">Configure Water Level Thresholds</h3>
                                    <p class="mb-0 opacity-75">Set automatic refill parameters</p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="threshold-config">
                                    <h5 class="mb-4">
                                        <i class="fas fa-sliders-h text-primary me-2"></i>Refill Settings
                                    </h5>

                                    <div class="mb-4">
                                        <label class="form-label d-flex justify-content-between">
                                            <span>Start Filling At</span>
                                            <span class="badge bg-primary" id="startFillValue">25%</span>
                                        </label>
                                        <div class="range-slider">
                                            <input type="range" class="form-range" min="10" max="50" step="5" value="25" id="startFillRange">
                                        </div>
                                        <small class="text-muted">System will start refilling when water level drops to this percentage</small>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label d-flex justify-content-between">
                                            <span>Stop Filling At</span>
                                            <span class="badge bg-success" id="stopFillValue">80%</span>
                                        </label>
                                        <div class="range-slider">
                                            <input type="range" class="form-range" min="60" max="95" step="5" value="80" id="stopFillRange">
                                        </div>
                                        <small class="text-muted">System will stop refilling when water level reaches this percentage</small>
                                    </div>

                                    <div class="alert alert-info">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>Recommendation:</strong> Keep at least 20% difference between start and stop levels for optimal operation.
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <div class="threshold-config">
                                    <h5 class="mb-4">
                                        <i class="fas fa-eye text-primary me-2"></i>Visual Preview
                                    </h5>

                                    <div class="text-center">
                                        <div class="water-tank-visual mx-auto" style="height: 250px; width: 120px;">
                                            <div class="position-absolute w-100 text-center" style="top: 20%; font-size: 0.75rem; color: #059669;" id="stopLine">
                                                ← Stop: <span id="stopPreview">80%</span>
                                            </div>
                                            <div class="position-absolute w-100 text-center" style="top: 75%; font-size: 0.75rem; color: #2563eb;" id="startLine">
                                                ← Start: <span id="startPreview">25%</span>
                                            </div>
                                            <div class="water-fill" id="previewWaterFill" style="height: 40%;"></div>
                                        </div>

                                        <div class="mt-3">
                                            <p class="text-muted mb-3">Current Level: <span class="fw-bold" id="currentLevelPreview">40%</span></p>
                                            <div class="d-grid">
                                                <button class="btn btn-success-custom btn-lg" id="completeSetupButton">
                                                    <i class="fas fa-check me-2"></i>Complete Setup
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5 hidden" id="successSection">
            <div class="col-12">
                <div class="card setup-card">
                    <div class="card-body p-5 text-center">
                        <i class="fas fa-check-circle icon-large text-success"></i>
                        <h2 class="text-success mb-3">Setup Complete!</h2>
                        <p class="lead mb-4">Your Hydrolink system is now configured and ready to use.</p>

                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="alert alert-success">
                                    <h5 class="alert-heading">What happens next?</h5>
                                    <ul class="text-start mb-0">
                                        <li>Your system will monitor water levels automatically</li>
                                        <li>Refilling will start when level drops to <span class="fw-bold" id="finalStartLevel">25%</span></li>
                                        <li>Refilling will stop when level reaches <span class="fw-bold" id="finalStopLevel">80%</span></li>
                                        <li>You'll receive notifications about system status</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button class="btn btn-primary-custom btn-lg" onclick="window.location.href='index.html'">
                                <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                            </button>
                            <button class="btn btn-outline-secondary btn-lg" id="adv-settings" onclick="window.location.href='settings.html'">
                                <i class="fas fa-cog me-2"></i>Advanced Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">
                <i class="fas fa-water text-primary me-2"></i>
                Hydrolink IoT &copy; 2024 - Smart Water Management Solutions
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js"; 

        // Firebase configuration (initialized once)
        const firebaseConfig = {
            apiKey: "AIzaSyCmFInEL6TMoD-9JwdPy-e9niNGGL5SjHA",
            authDomain: "hydrolink-d3c57.firebaseapp.com",
            databaseURL: "https://hydrolink-d3c57-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hydrolink-d3c57",
            storageBucket: "hydrolink-d3c57.firebasestorage.app",
            messagingSenderId: "770257381412",
            appId: "1:770257381412:web:a894f35854cb82274950b1"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Global variables
        let currentUserId = null;
        let DEVICE_ID = null; // This will be the Firebase UID of the ESP32
        let isScanning = false;
        let measureDrumFlagRef = null;
        let drumHeightRef = null;
        let deviceSettingsRef = null; // Reference to device settings
        let isAuthReady = false; // Flag to indicate if authentication is ready

        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const physicalInstallationSection = document.getElementById('physicalInstallationSection');
            const proceedToMacAddressBtn = document.getElementById('proceedToMacAddressBtn');
            const macAddressSection = document.getElementById('macAddressSection');
            const macAddressInput = document.getElementById('macAddressInput');
            const confirmMacAddressBtn = document.getElementById('confirmMacAddressBtn');
            const macAddressStatus = document.getElementById('macAddressStatus');
            const progressFill = document.getElementById('progressFill');
            const scanDrumSection = document.getElementById('scanDrumSection');
            const scanSection = document.getElementById('scanSection');
            const scanButton = document.getElementById('scanButton');
            const scanningIndicator = document.getElementById('scanningIndicator');
            const scanIcon = document.getElementById('scanIcon');
            const scanTitle = document.getElementById('scanTitle');
            const scanDescription = document.getElementById('scanDescription');
            const scanResults = document.getElementById('scanResults');
            const waterFill = document.getElementById('waterFill');
            const drumHeightDisplay = document.getElementById('drumHeightDisplay');
            const proceedButton = document.getElementById('proceedButton');
            const rescanButton = document.getElementById('rescanButton');
            const configurationSection = document.getElementById('configurationSection');
            const startFillRange = document.getElementById('startFillRange');
            const startFillValue = document.getElementById('startFillValue');
            const stopFillRange = document.getElementById('stopFillRange');
            const stopFillValue = document.getElementById('stopFillValue');
            const startPreview = document.getElementById('startPreview');
            const stopPreview = document.getElementById('stopPreview'); 
            const currentLevelPreview = document.getElementById('currentLevelPreview');
            const completeSetupButton = document.getElementById('completeSetupButton');
            const successSection = document.getElementById('successSection');
            const finalStartLevel = document.getElementById('finalStartLevel');
            const finalStopLevel = document.getElementById('finalStopLevel');

            // Function to show only one section and hide others
            function showSection(sectionIdToShow) {
                const sections = [
                    physicalInstallationSection,
                    macAddressSection,
                    scanDrumSection,
                    configurationSection,
                    successSection
                ];

                sections.forEach(section => {
                    if (section.id === sectionIdToShow) {
                        section.classList.remove('hidden');
                        section.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        section.classList.add('hidden');
                    }
                });
            }

            // Authentication state listener - this is now the primary entry point for auth logic
            onAuthStateChanged(auth, async (user) => { 
                if (user) {
                    currentUserId = user.uid;
                    console.log("User signed in:", user.email || "Anonymous", "UID:", currentUserId);
                    confirmMacAddressBtn.disabled = false;
                    macAddressStatus.innerHTML = `<div class="alert alert-info mt-2">Logged in as ${user.email || 'Anonymous User'}. Ready to link device.</div>`;

                    isAuthReady = true; 

                    // Attempt to sign in with custom token if available and not already signed in with it
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && user.uid !== auth.currentUser.uid) {
                         try {
                             await signInWithCustomToken(auth, __initial_auth_token);
                             console.log("Signed in with custom token (after initial session check).");
                         } catch (error) {
                             console.error("Firebase authentication error with custom token:", error);
                             displayMessage(`Authentication failed: ${error.message}. Please refresh the page.`, "danger");
                         }
                    }

                    // Attempt to load previously linked device ID from localStorage
                    const storedDeviceId = localStorage.getItem(`hydrolink_device_id_${currentUserId}`);
                    if (storedDeviceId) {
                        DEVICE_ID = storedDeviceId;
                        console.log("Loaded device ID from localStorage:", DEVICE_ID);
                        // Set Firebase refs for this device
                        initializeFirebaseRefs();
                        // If device is already linked, check its setup status
                        checkDeviceSetupStatus();
                    } else {
                        // If no stored device ID, show physical installation first
                        showSection('physicalInstallationSection');
                        updateProgress(0);
                    }

                } else {
                    currentUserId = null;
                    DEVICE_ID = null; // Clear device ID if user signs out
                    localStorage.removeItem(`hydrolink_device_id_${currentUserId}`); // Clear stored device ID
                    console.log("User signed out. Redirecting to login.");
                    // Only redirect if not already on auth.html to prevent loop
                    if (!window.location.pathname.endsWith('auth.html')) {
                        window.location.href = 'auth.html';
                    }
                }
            });

            // Function to initialize Firebase references once DEVICE_ID is known
            function initializeFirebaseRefs() {
                if (DEVICE_ID) {
                    measureDrumFlagRef = ref(database, `hydrolink/devices/${DEVICE_ID}/settings/measureDrum`);
                    drumHeightRef = ref(database, `hydrolink/devices/${DEVICE_ID}/settings/drumHeightCm`);
                    deviceSettingsRef = ref(database, `hydrolink/devices/${DEVICE_ID}/settings`);
                    console.log("Firebase refs initialized for DEVICE_ID:", DEVICE_ID);
                } else {
                    console.error("DEVICE_ID is null. Cannot initialize Firebase refs.");
                }
            }

            // Function to check the overall setup status of the linked device
            async function checkDeviceSetupStatus() {
                if (!DEVICE_ID) {
                    showSection('physicalInstallationSection'); 
                    updateProgress(0);
                    return;
                }

                // First, check if the device is linked to the current user in Firebase
                const userDeviceLinkRef = ref(database, `hydrolink/users/${currentUserId}/devices/${DEVICE_ID}`);
                const linkSnapshot = await get(userDeviceLinkRef);

                if (!linkSnapshot.exists() || !linkSnapshot.val()) {
                    console.warn("Device ID found in localStorage but not linked to current user in Firebase. Resetting.");
                    localStorage.removeItem(`hydrolink_device_id_${currentUserId}`);
                    DEVICE_ID = null; // Clear global DEVICE_ID
                    showSection('physicalInstallationSection');
                    updateProgress(0);
                    return;
                }

                // If linked, check drum height and other settings
                const settingsSnapshot = await get(deviceSettingsRef); // Use get for one-time read
                const settings = settingsSnapshot.val();

                if (settings && settings.drumHeightCm && settings.drumHeightCm > 0) {
                    console.log("Device already has drum height calibrated:", settings.drumHeightCm);
                    drumHeightDisplay.textContent = `${settings.drumHeightCm.toFixed(1)} cm`; 
                    scanSection.classList.add('completed');
                    scanResults.classList.remove('hidden');
                    updateProgress(100); 
                    showSection('configurationSection');
                    loadExistingDeviceSettings(); // Load thresholds if drum height is already set
                } else {
                    console.log("Device linked but drum height not calibrated. Proceeding to scan drum.");
                    showSection('scanDrumSection');
                    updateProgress(66); 
                    listenForDrumHeightMeasurement(); 
                }
            }


            // Event listener for "Proceed to Device Linking" button
            proceedToMacAddressBtn.addEventListener('click', () => {
                showSection('macAddressSection');
                updateProgress(33); 
            });

            // MAC address validation and linking
            confirmMacAddressBtn.addEventListener('click', async () => {
                const macAddress = macAddressInput.value.trim().toUpperCase();
                // Updated pattern to correctly handle hyphen or colon as separator
                const macRegex = /^([0-9A-F]{2}[-: ]){5}([0-9A-F]{2})$/; 

                macAddressStatus.innerHTML = '';
                macAddressInput.classList.remove('is-invalid');
                confirmMacAddressBtn.disabled = true;
                confirmMacAddressBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Checking...';

                const currentUser = auth.currentUser;
                if (!currentUser) {
                    displayMessage("You must be logged in to link a device.", "danger");
                    confirmMacAddressBtn.disabled = false;
                    confirmMacAddressBtn.innerHTML = '<i class="fas fa-link me-2"></i>Link Device';
                    return;
                }

                try {
                    if (!macRegex.test(macAddress)) {
                        macAddressInput.classList.add('is-invalid');
                        displayMessage('Please enter a valid MAC address (e.g., XX:XX:XX:XX:XX:XX or XX-XX-XX-XX-XX-XX).', "danger");
                        return;
                    }

                    displayMessage('Searching for device...', "info");

                    const macToUidRef = ref(database, `hydrolink/macToFirebaseUid/${macAddress}`);
                    const macSnapshot = await get(macToUidRef);

                    if (!macSnapshot.exists()) {
                        macAddressInput.classList.add('is-invalid');
                        displayMessage(`
                            <strong>Device not found!</strong><br>
                            The device with MAC address <code>${macAddress}</code> is not registered or not online.<br>
                            <small class="text-muted">Make sure your HydroLink device is powered on and connected to WiFi.</small>
                        `, "warning");
                        return;
                    }

                    const deviceId = macSnapshot.val(); 
                    displayMessage('Device found! Checking linking status...', "info");

                    const deviceLinkedUsersRef = ref(database, `hydrolink/devices/${deviceId}/linkedUsers`);
                    const linkedUsersSnapshot = await get(deviceLinkedUsersRef);
                    const linkedUsers = linkedUsersSnapshot.val(); 

                    if (linkedUsers && Object.keys(linkedUsers).length > 0) {
                        const linkedUserIds = Object.keys(linkedUsers);

                        if (linkedUserIds.includes(currentUser.uid)) {
                            displayMessage(`
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Device Already Linked!</strong><br>
                                This device is already connected to your account. Redirecting to dashboard...
                            `, "success");
                            localStorage.setItem(`hydrolink_device_id_${currentUser.uid}`, deviceId);
                            DEVICE_ID = deviceId; 
                            initializeFirebaseRefs(); 
                            setTimeout(() => {
                                window.location.href = 'index.html'; 
                            }, 2000);
                            return;
                        } else {
                            macAddressInput.classList.add('is-invalid');
                            displayMessage(`
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Device Already Linked!</strong><br>
                                This device is already connected to another user account and cannot be linked again.<br>
                                <small class="text-muted mt-2 d-block">
                                    Each HydroLink device can only be linked to one user account for security reasons.
                                    If this is your device, please contact support to transfer ownership.
                                </small>
                            `, "danger");
                            return;
                        }
                    }

                    displayMessage('Device available! Linking to your account...', "info");

                    // Set both user-device link and device-user link
                    await Promise.all([
                        set(ref(database, `hydrolink/users/${currentUser.uid}/devices/${deviceId}`), {
                            macAddress: macAddress,
                            linkedAt: serverTimestamp(), 
                            deviceName: `HydroLink Device (${macAddress.slice(-5).replace(/:/g, '')})` 
                        }),
                        set(ref(database, `hydrolink/devices/${deviceId}/linkedUsers/${currentUser.uid}`), {
                            linkedAt: serverTimestamp(),
                            userEmail: currentUser.email || 'N/A',
                            userName: currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Anonymous') || 'N/A'
                        })
                    ]);
                    
                    localStorage.setItem(`hydrolink_device_id_${currentUser.uid}`, deviceId);
                    DEVICE_ID = deviceId; 
                    initializeFirebaseRefs(); 

                    displayMessage(`
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Device Successfully Linked!</strong><br>
                        Your HydroLink device has been connected to your account. Proceeding to setup...
                    `, "success");

                    updateProgress(66); 

                    setTimeout(() => {
                        showSection('scanDrumSection');
                        loadExistingDeviceSettings(); 
                        listenForDrumHeightMeasurement(); 
                    }, 1500);

                } catch (error) {
                    console.error("Error linking device:", error);
                    displayMessage(`
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>Error Linking Device:</strong><br>
                        ${error.message}<br>
                        Please try again.
                    `, "danger");
                } finally {
                    confirmMacAddressBtn.disabled = false;
                    confirmMacAddressBtn.innerHTML = '<i class="fas fa-link me-2"></i>Link Device';
                }
            });

            // Loads existing device settings (drumHeight, thresholds) from Firebase
            async function loadExistingDeviceSettings() {
                if (!currentUserId || !DEVICE_ID || !deviceSettingsRef) return;

                // Use get() for a one-time read when loading existing settings
                const snapshot = await get(deviceSettingsRef); 
                const settings = snapshot.val();
                if (settings) {
                    console.log("Loading existing device settings:", settings);
                    if (settings.drumHeightCm && settings.drumHeightCm > 0) {
                        drumHeightDisplay.textContent = `${settings.drumHeightCm.toFixed(1)} cm`;
                        scanSection.classList.add('completed');
                        scanResults.classList.remove('hidden');
                        scanIcon.className = 'fas fa-check-circle icon-large text-success';
                        scanTitle.textContent = 'Drum Height Measured';
                        scanDescription.textContent = 'Empty drum height measurement successful!';
                    }
                    if (settings.refillThresholdPercentage) {
                        startFillRange.value = settings.refillThresholdPercentage;
                        updateStartFillValue();
                    }
                    if (settings.maxFillLevelPercentage) {
                        stopFillRange.value = settings.maxFillLevelPercentage;
                        updateStopFillValue();
                    }
                } else {
                    console.log("No existing settings found for this device. Will use defaults.");
                }
            }

            // Listen for drum height measurement from Firebase
            function listenForDrumHeightMeasurement() {
                if (!drumHeightRef) {
                    console.error("drumHeightRef is not initialized. Cannot listen for drum height.");
                    return;
                }

                // Attach listener only if not already listening
                // This 'onValue' listener should ideally be set up once when entering the scan drum section
                // and potentially detached when leaving it if performance is critical,
                // but for a setup flow, keeping it active is fine.
                onValue(drumHeightRef, (snapshot) => {
                    const heightCm = snapshot.val();
                    if (heightCm !== null && typeof heightCm === 'number' && heightCm > 0 && isScanning) {
                        console.log("Received drum height measurement:", heightCm);
                        completeDrumHeightScan(heightCm);
                    } else if (heightCm === 0 && isScanning) {
                         // If 0 is received while scanning, it might indicate an.
                         // For now, we'll just let the scan timeout or user rescan
                    }
                });
            }

            // Event listener for "Scan Water Drum Now" button
            scanButton.addEventListener('click', triggerDrumMeasurement);

            async function triggerDrumMeasurement() {
                if (!currentUserId || !DEVICE_ID || !measureDrumFlagRef) {
                    displayMessage("Authentication or Device ID missing. Please log in and ensure device is linked.", "danger");
                    return;
                }

                if (isScanning) return; 

                isScanning = true;
                scanButton.style.display = 'none';
                scanningIndicator.classList.remove('hidden');
                scanSection.classList.add('scanning');
                scanIcon.className = 'fas fa-spinner fa-spin icon-large text-warning';
                scanTitle.textContent = 'Measuring Drum Height';
                scanDescription.textContent = 'Please wait while your Hydrolink device measures the total height of your empty water drum...';

                try {
                    await set(measureDrumFlagRef, true);
                    console.log("Requested drum measurement from ESP32 via Firebase.");
                } catch (error) {
                    console.error("Error requesting drum measurement from Firebase:", error);
                    displayMessage("Failed to request drum measurement from device. Please check Firebase connection and try again.", "danger");
                    resetScanSection();
                }
            }

            function completeDrumHeightScan(heightCm) {
                isScanning = false; 
                scanSection.classList.remove('scanning');
                scanSection.classList.add('completed');
                scanningIndicator.classList.add('hidden');
                scanIcon.className = 'fas fa-check-circle icon-large text-success';
                scanTitle.textContent = 'Drum Height Measured';
                scanDescription.textContent = 'Empty drum height measurement successful!';

                scanResults.classList.remove('hidden');
                updateDrumHeightDisplay(heightCm);
                proceedButton.focus(); 
            }

            function updateDrumHeightDisplay(heightCm) {
                drumHeightDisplay.textContent = `${heightCm.toFixed(1)} cm`;
                waterFill.style.height = '0%'; 
                currentLevelPreview.textContent = '0% (Empty)'; 
            }

            // Event listener for "Proceed to Configuration" button
            proceedButton.addEventListener('click', () => {
                showSection('configurationSection');
                updateProgress(100); 
                updateStartFillValue();
                updateStopFillValue();
            });

            // Event listener for "Measure Again" button
            rescanButton.addEventListener('click', resetScanSection);

            function resetScanSection() {
                isScanning = false;
                scanSection.classList.remove('completed');
                scanSection.classList.remove('scanning');
                scanResults.classList.add('hidden');
                scanButton.style.display = 'inline-block'; 
                scanningIndicator.classList.add('hidden'); 
                scanIcon.className = 'fas fa-radar-chart icon-large text-primary';
                scanTitle.textContent = 'Ready to Scan';
                scanDescription.textContent = 'Make sure your water drum is EMPTY, then click the button below to measure the total height of your drum.';
                updateProgress(66); 
                drumHeightDisplay.textContent = '0.0 cm'; 
                showSection('scanDrumSection'); 
            }

            // Event listeners for range sliders
            startFillRange.addEventListener('input', updateStartFillValue);
            stopFillRange.addEventListener('input', updateStopFillValue);

            function updateStartFillValue() {
                const value = parseInt(startFillRange.value);
                startFillValue.textContent = value + '%';
                startPreview.textContent = value + '%';
                const startLine = document.getElementById('startLine');
                startLine.style.top = (100 - value) + '%';
                if (parseInt(stopFillRange.value) <= value) {
                    stopFillRange.value = Math.min(value + 20, parseInt(stopFillRange.max));
                    updateStopFillValue();
                }
                updatePreviewWaterFill();
            }

            function updateStopFillValue() {
                const value = parseInt(stopFillRange.value);
                stopFillValue.textContent = value + '%';
                stopPreview.textContent = value + '%';
                const stopLine = document.getElementById('stopLine');
                stopLine.style.top = (100 - value) + '%';
                if (parseInt(startFillRange.value) >= value) {
                    startFillRange.value = Math.max(value - 20, parseInt(startFillRange.min));
                    updateStartFillValue();
                }
                updatePreviewWaterFill();
            }

            function updatePreviewWaterFill() {
                const startValue = parseInt(startFillRange.value);
                const stopValue = parseInt(stopFillRange.value);

                const visualCurrentLevel = (startValue + stopValue) / 2;
                currentLevelPreview.textContent = `${visualCurrentLevel.toFixed(0)}%`;
                previewWaterFill.style.height = `${visualCurrentLevel}%`;
            }

            // Event listener for "Complete Setup" button
            completeSetupButton.addEventListener('click', completeSetup);

            async function completeSetup() {
                if (!currentUserId || !DEVICE_ID || !deviceSettingsRef) {
                    displayMessage("Authentication or Device ID missing. Please log in and ensure device is linked.", "danger");
                    return;
                }

                const drumHeight = parseFloat(drumHeightDisplay.textContent); 
                const startLevel = parseInt(startFillRange.value);
                const stopLevel = parseInt(stopFillRange.value);

                try {
                    const settings = {
                        drumHeightCm: drumHeight,
                        refillThresholdPercentage: startLevel,
                        maxFillLevelPercentage: stopLevel
                    };

                    await set(deviceSettingsRef, settings);
                    
                    console.log("Settings saved successfully:", settings);
                    
                    finalStartLevel.textContent = `${startLevel}%`;
                    finalStopLevel.textContent = `${stopLevel}%`;

                    showSection('successSection');
                    
                } catch (error) {
                    console.error("Error saving settings:", error);
                    displayMessage(`Failed to save settings: ${error.message}. Please try again.`, "danger");
                }
            }

            function updateProgress(percentage) {
                progressFill.style.width = percentage + '%';
            }

            function displayMessage(message, type) {
                let messageContainer = document.getElementById('macAddressStatus'); 
                if (!messageContainer) { 
                    messageContainer = document.createElement('div');
                    document.body.appendChild(messageContainer);
                }
                messageContainer.innerHTML = `<div class="alert alert-${type} mt-2">${message}</div>`;
                setTimeout(() => {
                    messageContainer.innerHTML = ''; 
                }, 4000);
            }
        });
    </script>
</body>
</html>